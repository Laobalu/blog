# 什么是执行上下文  
执行上下文就是当前 JavaScript 代码被解析和执行时所在环境的抽象概念， JavaScript 中运行任何的代码都是在执行上下文中运行，包含了当前调用的所有信息。简言之 **执行上下文就是 JavaScript 执行一段代码块时的运行环境** 。 

## 执行上下文类型 
根据代码不同的运行场景，执行上下文有不同类型。  
- 全局执行上下文：默认上下文，当代码运行时，JavaScript 引擎首先创建一个全局执行上下文来执行全局代码。他会做两件事，创建一个全局对象window（浏览器），并且设置this指向window。
- 函数执行上下文 - 每个函数被调用，都会创建自己的上下文，来执行该函数代码。
- eval执行上下文 - eval也有自己的上下文。（尽量不使用）

## 执行上下文何时产生
任何JavaScript代码片段在执行前都要进行编译，然后做好执行它的准备，并且通常会马上执行它。执行上下文就是在代码编译阶段产生的。  

    编译过程：
    1. 分词/词法分析：程序分解为词法单元
    2. 解析/语法分析：形成抽象语法树
    3. 代码生成：转化为可执行代码  

![执行上下文_02](../images/执行上下文_02.png)


## 执行栈
一段常见的JavaScript代码会有全局代码和多个函数，对应的就会有一个全局执行上下文和多个函数执行上下文，那么js引擎又是如何管理这些执行上下文的呢？  

    执行栈，它是一种用来管理执行上下文的数据结构，遵循 LIFO（后进先出） 原则。
步骤：  
1. js引擎首次读取脚本时，它会编译代码，创建全局上下文，并压入栈底。
2. 每当有一个函数调用，引擎会编译代码，为该函数创建一个新的执行上下文，并压入栈顶。
3. 引擎会执行栈顶上下文中的可执行代码，当执行结束后，该执行上下文从栈中弹出，js引擎控制流程到下一个执行上下文，直到全局代码被执行完。
```js
const a = 100
function fun(b) {
  return a * b
}
const c = fun(2)
```
![执行上下文_01](../images/执行上下文_01.png)

# 执行上下文如何创建
上文从**宏观**层面介绍了什么是执行上下文，它是在何时被创建的，以及如何管理它们。现在让我们从**微观**角度看JavaScript引擎是如何创建上下文的。

    JavaScript如今已经迭代了多个版本，执行上下文的创建也不尽相同。
## es3规范上下文生命周期
- 创建阶段  
  1. 创建作用域链    
  2. 创建变量对象，用当前函数的参数列表(arguments)初始化一个“变量对象”并将当前执行上下文与之关联，并且，函数代码块中声明的变量和函数将作为属性添加到这个变量对象上(即变量声明提升)。
  3. this绑定
- 激活/执行阶段  
代码逐行开始执行，有对定义的变量赋值、顺着作业域链访问变量如果内部有函数调用就创建一个新的执行上下文压入执行栈并把控制权交出等操作。
- 销毁阶段  
当函数执行完成后，当前执行上下文会被弹出执行上下文栈并且销毁，控制权被重新交给执行栈上一层的执行上下文。

## es5规范上下文生命周期

- 创建阶段  
  1. this绑定
  2. 创建**词法环境**
  3. 创建**变量环境**
- 激活/执行阶段  
完成变量分配，执行代码。
- 销毁阶段
上下文弹出销毁，进入下一个上下文。  

# es5执行上下文详解  
    ES5对ES3中的部分概念进行了修改，去掉了变量对象、活动对象和作用域，变为了词法环境(lexical environment)和变量环境(variable environment)。  
```js
ExecutionContext = {
  LexicalEnvironment = <ref. to LexicalEnvironment in memory>,
  VariableEnvironment = <ref. to VariableEnvironment in  memory>,
}
```

## 1. 词法环境（Lexical Environment）
    词法环境是一种规范，用于在 ECMAScript 代码的词法嵌套结构中定义标识符、特定变量以及函数的关联。  
简单来说词法环境是一种持有**标识符-变量**映射的结构。（这里的标识符指的是变量/函数的名字，而变量是对实际对象[包含函数类型对象]或原始数据的引用）。   
词法环境由两部分组成：
- 环境记录器：存储变量和函数声明
- 外部环境的引用：通过它可以访问外部词法环境   

![执行上下文_01](../images/执行上下文_03.png)

### 词法环境类型
- 全局环境（在全局执行上下文中）是没有外部环境引用的词法环境。全局环境的外部环境引用是 null。它拥有内建的 Object/Array/等、在环境记录器内的原型函数（关联全局对象，比如 window 对象）还有任何用户定义的全局变量，并且 this的值指向全局对象。
- 在函数环境中，函数内部用户定义的变量存储在环境记录器中。并且引用的外部环境可能是全局环境，或者任何包含此内部函数的外部函数。
```js
GlobalExectionContext = {
  LexicalEnvironment: {
    EnvironmentRecord: {
      Type: "Object",
      // 在这里绑定标识符
    }
    // 全局外部引用为空
    outer: <null> 
  }
}

FunctionExectionContext = {
  LexicalEnvironment: {
    EnvironmentRecord: {
      Type: "Declarative",
      // 在这里绑定标识符
    }
    outer: <Global or outer function environment reference>
  }
}

```

## 2. 环境记录器（Environment Record）



